<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Agent Detalları</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Dark Mode Variables (Default) */
            --bg-primary: #12121e;
            --bg-secondary: #1f2937;
            --bg-card: rgba(31, 41, 55, 0.5); /* Semi-transparent for blur effect */
            --text-primary: #e5e7eb; /* gray-200 */
            --text-secondary: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --indigo-accent: #4f46e5; /* indigo-600 */
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Light Mode Variables (Yumşaq, Peşəkar görünüş) */
        .light-mode {
            --bg-primary: #f7f9fc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1f2937; /* dark text */
            --text-secondary: #6b7280; /* medium gray */
            --border-color: #e5e7eb; /* light gray border */
            --indigo-accent: #4338ca; /* darker indigo */
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* Card styles */
        .card {
            background-color: var(--bg-card);
            border: 1px solid rgba(var(--border-color), 0.3); /* Yüngül şəffaf border */
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(2px); /* Yüngül blur effekti */
            -webkit-backdrop-filter: blur(2px);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .light-mode .card {
             border-color: var(--border-color); /* Light mode kart sərhədi */
             backdrop-filter: none; /* Light modeda blur yoxdur */
            -webkit-backdrop-filter: none;
        }

        /* Sidebar nav active link */
        .nav-active {
            background-color: #3730A3; /* Dark mode specific */
            color: #E0E7FF;
            font-weight: 600;
        }
        .light-mode .nav-active {
            background-color: #e0e7ff; /* Lighter indigo background */
            color: var(--indigo-accent);
        }

        /* Other elements to adapt to theme */
        .bg-gray-800 { background-color: var(--bg-secondary) !important; }
        .bg-gray-900 { background-color: var(--bg-primary) !important; }
        .border-gray-700 { border-color: var(--border-color) !important; }
        .text-gray-200 { color: var(--text-primary) !important; }
        .text-gray-300 { color: var(--text-primary) !important; } /* Agent details text */
        .text-gray-400 { color: var(--text-secondary) !important; }
        .text-gray-500 { color: var(--text-secondary) !important; } /* Footer text */
        .bg-indigo-600 { background-color: var(--indigo-accent) !important; }
        .hover\:bg-indigo-700:hover { background-color: #3730A3 !important; } /* Slightly darker on hover */

        /* Anomaly Modal specific styling for theme */
        #anomalyModal > div {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            box-shadow: var(--card-shadow);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        /* Toggle Button Styles */
        #themeToggle {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        #toggleIndicator {
            background-color: var(--indigo-accent);
            color: white;
            transition: transform 0.3s, background-color 0.3s;
        }
        .light-mode #toggleIndicator {
            transform: translateX(100%);
        }

        /* Process table header */
        #agentProcesses thead {
            background-color: var(--bg-secondary) !important; /* Tailwind's bg-gray-700 */
            color: var(--text-primary) !important;
            border-bottom: 1px solid var(--border-color);
        }
        #processTableBody tr {
             color: var(--text-primary); /* Default row text */
        }
        #processTableBody tr:hover {
             background-color: rgba(var(--border-color), 0.2); /* Hover effect for table rows */
        }
        #processTableBody td {
            border-bottom: 1px solid var(--border-color);
        }
        #processTableBody tr:last-child td {
            border-bottom: none; /* Sonuncu sətrin altında border olmasın */
        }
    </style>
</head>

<body class="min-h-screen flex">
    <aside class="w-72 bg-gray-900 border-r border-gray-700 p-6 hidden md:block shadow-xl" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <div class="flex items-center gap-3 mb-10">
            <div class="h-16 w-16 flex items-center justify-center">
                <img src="logo.png" alt="FORAM Logo" class="h-12 w-12 object-contain" />
            </div>
            <div>
                <h3 class="text-xl font-extrabold" style="color: var(--text-primary);">RAM Forensic</h3>
                <p class="text-xs font-medium" style="color: var(--indigo-accent);">Kibertəhlükəsizlik Mərkəzi RAM Forensic Sistemi</p>
            </div>
        </div>

        <nav class="space-y-2 text-sm">
            <a href="dashboard.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3z" />
                </svg>
                Dashboard
            </a>
            <a href="agents.html" class="flex items-center gap-3 px-4 py-2 rounded-lg nav-active transition-colors" style="color: var(--text-primary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                Agentlər
            </a>
            <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.313.823 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.823 3.313-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.313-.823-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.823-3.313 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                İnsidentlər
            </a>
             <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 2v-6m2 9H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                Hesabatlar
            </a>
            <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                </svg>
                Parametrlər
            </a>
        </nav>

        <div class="mt-12 text-xs space-y-1" style="color: var(--text-secondary);">
            <p class="font-medium">SIEM Core v2.1.0</p>
            <p>© 2025 SIEM. Bütün hüquqlar qorunur.</p>
        </div>
    </aside>

    <div class="flex-1 p-8 overflow-auto">
        <header class="flex items-center justify-between pb-6 border-b mb-8" style="border-color: var(--border-color);">
            <div>
                <h1 class="text-3xl font-extrabold" style="color: var(--text-primary);">Agent Detalları</h1>
                <p class="text-sm mt-1" style="color: var(--text-secondary);">Seçilmiş agentin real-vaxt məlumatları və anomaliyaları</p>
            </div>

            <div class="flex items-center gap-4">
                <button id="themeToggle" class="w-12 h-6 flex items-center rounded-full p-0.5 shadow-inner transition-colors duration-300">
                    <div id="toggleIndicator" class="h-5 w-5 rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center text-xs">
                         <svg xmlns="http://www.w3.org/2000/svg" id="modeIcon" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </div>
                </button>
                <button id="anomalyBtn" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 rounded-lg text-white font-medium transition-colors shadow-md">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                    </svg>
                    Anomaliyaları Yoxla
                </button>
            </div>
        </header>

        <section id="agentInfo" class="card rounded-2xl p-6 shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--indigo-accent);">Agent Məlumatları</h2>
            <div id="agentDetails" class="grid grid-cols-1 md:grid-cols-2 gap-x-6 gap-y-4 text-sm" style="color: var(--text-primary);">
                <p>Yüklənir...</p>
            </div>
        </section>

        <section id="agentProcesses" class="card rounded-2xl p-6 shadow-lg mb-6">
            <h2 class="text-xl font-semibold mb-4" style="color: var(--indigo-accent);">Proseslər</h2>
            <div class="overflow-x-auto rounded-xl">
                <table class="min-w-full">
                    <thead class="sticky top-0 rounded-t-xl" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                        <tr>
                            <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">PID</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Ad</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">User</th>
                            <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody id="processTableBody" class="divide-y" style="border-color: var(--border-color);">
                        <tr><td colspan="4" class="text-center py-6" style="color: var(--text-secondary);">Proseslər yüklənir...</td></tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination" class="flex justify-center items-center gap-2 mt-6"></div>
        </section>

        <div id="anomalyModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300">
            <div class="card rounded-2xl shadow-2xl w-full max-w-lg p-6 relative transform transition-transform duration-300 scale-95 opacity-0" id="modalDialog"
                 style="background-color: var(--bg-secondary); color: var(--text-primary);">
                <button id="closeAnomalyModal" class="absolute top-4 right-4 hover:text-white transition-colors" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 class="text-2xl font-bold mb-4 pb-2" style="border-color: var(--border-color); color: var(--indigo-accent);">Agent Anomaliyaları</h2>
                <ul id="anomalyList" class="space-y-3 text-sm max-h-80 overflow-y-auto pr-2" style="color: var(--text-primary);">
                    <li>Anomaliyalar yüklənir...</li>
                </ul>
                <div class="mt-6 flex justify-end pt-4" style="border-top: 1px solid var(--border-color);">
                     <button id="modalCloseBtn" class="px-4 py-2 border rounded-lg transition-colors"
                            style="border-color: var(--border-color); color: var(--text-primary); hover:border-color: var(--text-secondary);">Bağla</button>
                </div>
            </div>
        </div>

        <footer class="text-xs mt-12 flex justify-between items-center pt-4" style="color: var(--text-secondary); border-top: 1px solid var(--border-color);">
            <p class="text-sm">Korporativ Təhlükəsizlik Sistemi | Bütün hüquqlar qorunur. © 2025 SIEM</p>
            <img src="mn.png" alt="MN Korporativ Şəkil" class="h-12 object-contain opacity-80" />
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const htmlElement = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            const toggleIndicator = document.getElementById('toggleIndicator');
            const modeIcon = document.getElementById('modeIcon');
            const anomalyModal = document.getElementById('anomalyModal');
            const modalDialog = document.getElementById('modalDialog');
            const closeAnomalyModal = document.getElementById('closeAnomalyModal');
            const modalCloseBtn = document.getElementById('modalCloseBtn'); // Added for the modal close button

            // --- Theme Functions ---
            function updateTheme(isLight) {
                if (isLight) {
                    htmlElement.classList.add('light-mode');
                    htmlElement.classList.remove('dark-mode');
                    toggleIndicator.style.transform = 'translateX(100%)';
                    modeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`; // Sun icon
                } else {
                    htmlElement.classList.remove('light-mode');
                    htmlElement.classList.add('dark-mode');
                    toggleIndicator.style.transform = 'translateX(0)';
                    modeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />`; // Moon icon
                }
            }

            // 1. Check saved preference or default to dark
            const savedTheme = localStorage.getItem('theme');
            const isLightMode = savedTheme === 'light';
            updateTheme(isLightMode);

            // 2. Toggle button listener
            themeToggle.addEventListener('click', () => {
                const isCurrentlyLight = htmlElement.classList.contains('light-mode');
                const newTheme = isCurrentlyLight ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                updateTheme(!isCurrentlyLight);
            });
            
            // --- Existing Agent Detail Logic ---
            const urlParams = new URLSearchParams(window.location.search);
            const agentId = urlParams.get('id');

            const agentDetailsElem = document.getElementById('agentDetails');
            const processTableBody = document.getElementById('processTableBody');
            const paginationElem = document.getElementById('pagination');

            const anomalyBtn = document.getElementById('anomalyBtn');
            const anomalyList = document.getElementById('anomalyList');

            let processes = [];
            let currentPage = 1;
            const pageSize = 10;
            const API_BASE_URL = 'http://localhost:5000/api';

            async function fetchAgentDetails() {
                if (!agentId) {
                    agentDetailsElem.innerHTML = '<p class="text-red-400">Xəta: URL-də agent ID tapılmadı.</p>';
                    processTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-red-400">Agent ID olmadan proseslər yüklənə bilməz.</td></tr>';
                    return;
                }

                try {
                    const res = await fetch(`${API_BASE_URL}/agents/${agentId}`);
                    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
                    const data = await res.json();

                    agentDetailsElem.innerHTML = `
                        <p class="font-medium" style="color: var(--text-secondary);">ID:</p><p class="font-semibold" style="color: var(--text-primary);">${data._id}</p>
                        <p class="font-medium" style="color: var(--text-secondary);">Ad:</p><p class="font-semibold" style="color: var(--text-primary);">${data.name}</p>
                        <p class="font-medium" style="color: var(--text-secondary);">ƏS:</p><p class="font-semibold" style="color: var(--text-primary);">${data.os}</p>
                        <p class="font-medium" style="color: var(--text-secondary);">IP Ünvanı:</p><p class="font-semibold" style="color: var(--text-primary);">${data.ipAddress}</p>
                        <p class="font-medium" style="color: var(--text-secondary);">Status:</p><p class="font-semibold" style="color: var(--text-primary);">
                           <span class="inline-block h-3 w-3 rounded-full ${data.status.toLowerCase() === 'active' ? 'bg-green-500' : 'bg-red-500'} mr-2"></span>
                           ${data.status.charAt(0).toUpperCase() + data.status.slice(1)}
                        </p>
                        <p class="font-medium" style="color: var(--text-secondary);">Versiya:</p><p class="font-semibold" style="color: var(--text-primary);">${data.version}</p>
                        <p class="font-medium" style="color: var(--text-secondary);">Son Görülmə:</p><p class="font-semibold" style="color: var(--text-primary);">${new Date(data.lastSeen).toLocaleString('az-AZ')}</p>
                    `;

                    processes = data.agentDataHistory?.[0]?.processData || [];
                    renderProcesses();
                } catch (err) {
                    console.error('Agent detalları yüklənmədi:', err);
                    agentDetailsElem.innerHTML = `<p class="text-red-400">Detallar yüklənərkən xəta baş verdi: ${err.message}</p>`;
                    processTableBody.innerHTML = '<tr><td colspan="4" class="text-center py-6 text-red-400">Proseslər yüklənmədi.</td></tr>';
                }
            }

            function renderProcesses() {
                processTableBody.innerHTML = '';
                const start = (currentPage - 1) * pageSize;
                const paginated = processes.slice(start, start + pageSize);

                if (paginated.length === 0) {
                    processTableBody.innerHTML = `<tr><td colspan="4" class="text-center py-6" style="color: var(--text-secondary);">Proses yoxdur.</td></tr>`;
                } else {
                    paginated.forEach(p => {
                        const statusClass = p.status.toLowerCase() === 'running' ? 'text-green-400' : 'text-yellow-400';
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-gray-700/50 transition-colors'; // Add hover class
                        row.innerHTML = `
                            <td class="py-3 px-4 text-sm" style="color: var(--text-primary);">${p.pid}</td>
                            <td class="py-3 px-4 text-sm font-medium" style="color: var(--text-primary);">${p.name}</td>
                            <td class="py-3 px-4 text-sm" style="color: var(--text-secondary);">${p.username}</td>
                            <td class="py-3 px-4 text-sm"><span class="${statusClass} font-semibold">${p.status}</span></td>
                        `;
                        processTableBody.appendChild(row);
                    });
                }
                renderPagination();
            }

            function renderPagination() {
                paginationElem.innerHTML = '';
                const totalPages = Math.ceil(processes.length / pageSize);
                if (totalPages <= 1) return;

                const prevBtn = document.createElement('button');
                prevBtn.textContent = 'Əvvəlki';
                prevBtn.disabled = currentPage === 1;
                prevBtn.className = 'px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 disabled:opacity-50 text-sm transition-colors'
                prevBtn.style.backgroundColor = 'var(--bg-secondary)';
                prevBtn.style.color = 'var(--text-secondary)';
                prevBtn.style.borderColor = 'var(--border-color)';
                prevBtn.addEventListener('click', () => { if (currentPage > 1) { currentPage--; renderProcesses(); } });
                paginationElem.appendChild(prevBtn);

                for (let i = 1; i <= totalPages; i++) {
                    const isNear = Math.abs(i - currentPage) <= 1;
                    const isBoundary = i === 1 || i === totalPages;

                    if (isBoundary || isNear) {
                        const btn = document.createElement('button');
                        btn.textContent = i;
                        btn.className = `w-10 h-10 flex items-center justify-center rounded-full text-sm font-medium transition-colors ${i === currentPage ? 'text-white' : ''}`;
                        btn.style.backgroundColor = i === currentPage ? 'var(--indigo-accent)' : 'var(--bg-secondary)';
                        btn.style.color = i === currentPage ? 'white' : 'var(--text-primary)';
                        btn.style.borderColor = 'var(--border-color)';
                        btn.addEventListener('click', () => { currentPage = i; renderProcesses(); });
                        paginationElem.appendChild(btn);
                    } else if (i === currentPage - 2 || i === currentPage + 2) {
                        const span = document.createElement('span');
                        span.textContent = '...';
                        span.className = 'px-1'
                        span.style.color = 'var(--text-secondary)';
                        paginationElem.appendChild(span);
                    }
                }

                const nextBtn = document.createElement('button');
                nextBtn.textContent = 'Sonrakı';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.className = 'px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600 disabled:opacity-50 text-sm transition-colors'
                nextBtn.style.backgroundColor = 'var(--bg-secondary)';
                nextBtn.style.color = 'var(--text-secondary)';
                nextBtn.style.borderColor = 'var(--border-color)';
                nextBtn.addEventListener('click', () => { if (currentPage < totalPages) { currentPage++; renderProcesses(); } });
                paginationElem.appendChild(nextBtn);
            }

            anomalyBtn.addEventListener('click', async () => {
                if (!agentId) {
                    anomalyList.innerHTML = '<li>Agent ID mövcud deyil. Anomaliyalar yüklənə bilməz.</li>';
                    anomalyModal.classList.remove('hidden');
                    setTimeout(() => {
                        modalDialog.classList.add('scale-100', 'opacity-100');
                        modalDialog.classList.remove('scale-95', 'opacity-0');
                    }, 10);
                    return;
                }

                anomalyList.innerHTML = '<li>Anomaliyalar yüklənir...</li>';
                anomalyModal.classList.remove('hidden');
                setTimeout(() => {
                    modalDialog.classList.add('scale-100', 'opacity-100');
                    modalDialog.classList.remove('scale-95', 'opacity-0');
                }, 10);

                try {
                    const res = await fetch(`${API_BASE_URL}/agents/${agentId}/anomaly/processes`);
                    if (!res.ok) throw new Error(`HTTP status ${res.status}`);
                    const data = await res.json();

                    anomalyList.innerHTML = '';
                    if (!data.anomalies || data.anomalies.length === 0) {
                        anomalyList.innerHTML = `
                            <li class="p-3 rounded-md border border-green-700 text-green-400 bg-green-900/40 shadow-md">
                                Heç bir anomaliya tapılmadı. ✅
                            </li>`;
                    } else {
                        data.anomalies.forEach(a => {
                            const li = document.createElement('li');
                            li.className = 'p-3 rounded-md border border-red-700 text-red-400 bg-red-900/40 shadow-md';
                            li.innerHTML = `
                                <strong class="text-red-400">${a.type}</strong>: ${a.message}
                                <span class="block text-xs" style="color: var(--text-secondary); margin-top: 4px;">
                                    (Limit: ${a.threshold}, Cari Dəyər: ${a.value})
                                </span>
                            `;
                            anomalyList.appendChild(li);
                        });
                    }
                } catch (err) {
                    console.error('Anomaliyalar yüklənmədi:', err);
                    anomalyList.innerHTML = `
                        <li class="p-3 rounded-md border border-yellow-700 text-yellow-400 bg-yellow-900/40 shadow-md">
                            Anomaliyalar yüklənərkən xəta baş verdi: ${err.message} 🚨
                        </li>`;
                }
            });

            // Close anomaly modal function
            const closeAndResetModal = () => {
                modalDialog.classList.remove('scale-100', 'opacity-100');
                modalDialog.classList.add('scale-95', 'opacity-0');
                anomalyModal.classList.remove('opacity-100');
                setTimeout(() => { anomalyModal.classList.add('hidden'); }, 300);
            };

            closeAnomalyModal.addEventListener('click', closeAndResetModal);
            modalCloseBtn.addEventListener('click', closeAndResetModal); // Listener for the added close button
            anomalyModal.addEventListener('click', (e) => {
                if (e.target === anomalyModal) closeAndResetModal();
            });
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape' && !anomalyModal.classList.contains('hidden')) closeAndResetModal();
            });

            fetchAgentDetails();
        });
    </script>
</body>
</html>
