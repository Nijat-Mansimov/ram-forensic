<!DOCTYPE html>
<html lang="az">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>SIEM Korporativ Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            /* Dark Mode Variables (Default) */
            --bg-primary: #12121e;
            --bg-secondary: #1f2937;
            --bg-card: rgba(31, 41, 55, 0.5);
            --text-primary: #e5e7eb; /* gray-200 */
            --text-secondary: #9ca3af; /* gray-400 */
            --border-color: #374151; /* gray-700 */
            --indigo-accent: #4f46e5; /* indigo-600 */
            --card-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
        }

        /* Light Mode Variables (Yumşaq, Peşəkar görünüş) */
        .light-mode {
            --bg-primary: #f7f9fc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1f2937; /* dark text */
            --text-secondary: #6b7280; /* medium gray */
            --border-color: #e5e7eb; /* light gray border */
            --indigo-accent: #4338ca; /* darker indigo */
            --card-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-primary);
            color: var(--text-primary); /* Use primary text color */
            transition: background-color 0.3s, color 0.3s;
        }

        /* Status rəngləri (dəyişməz qalır) */
        .status-active { color: #34D399; }
        .status-inactive { color: #F87171; }
        .status-pending { color: #FBBF24; }

        /* Card styles */
        .card {
            background-color: var(--bg-card);
            border: 1px solid rgba(var(--border-color), 0.3);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            transition: background-color 0.3s, border-color 0.3s, box-shadow 0.3s;
        }

        .light-mode .card {
             border-color: var(--border-color); /* Light mode kart sərhədi */
             backdrop-filter: none;
            -webkit-backdrop-filter: none;
        }

        /* Nav active link color */
        .nav-active {
            background-color: #3730A3; /* Dark mode specific */
            color: #E0E7FF;
            font-weight: 600;
        }
        .light-mode .nav-active {
            background-color: #e0e7ff; /* Lighter indigo background */
            color: var(--indigo-accent);
        }

        /* Table header, inputs (Use secondary background and border) */
        .bg-gray-900, .bg-gray-700 {
            background-color: var(--bg-secondary) !important;
            border-color: var(--border-color) !important;
        }
        .text-gray-400, .text-gray-500 {
            color: var(--text-secondary) !important;
        }
        .text-white {
             color: var(--text-primary) !important;
        }
        .text-indigo-300, .text-indigo-400 {
            color: var(--indigo-accent) !important;
        }

        /* Toggle Button Styles */
        #themeToggle {
            background-color: var(--bg-secondary);
            border: 1px solid var(--border-color);
            transition: background-color 0.3s, border-color 0.3s;
        }
        #toggleIndicator {
            background-color: var(--indigo-accent);
            color: white;
            transition: transform 0.3s, background-color 0.3s;
        }
        .light-mode #toggleIndicator {
            transform: translateX(100%);
        }
    </style>
</head>

<body class="min-h-screen flex">
    <aside class="w-72 bg-gray-900 border-r border-gray-700 p-6 hidden md:block shadow-xl" style="background-color: var(--bg-secondary); border-color: var(--border-color);">
        <div class="flex items-center gap-3 mb-10">
            <div class="h-16 w-16 flex items-center justify-center">
                <img src="logo.png" alt="FORAM Logo" class="h-12 w-12 object-contain" />
            </div>
            <div>
                <h3 class="text-xl font-extrabold" style="color: var(--text-primary);">RAM Forensic</h3>
                <p class="text-xs font-medium" style="color: var(--indigo-accent);">Kibertəhlükəsizlik Mərkəzi RAM Forensic Sistemi</p>
            </div>
        </div>

        <nav class="space-y-2 text-sm">
            <a href="#" class="flex items-center gap-3 px-4 py-2 rounded-lg nav-active transition-colors" style="color: var(--text-primary);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h18v18H3z" />
                </svg>
                Dashboard
            </a>
            <a href="anomalies.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary); hover:background-color: var(--border-color);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" />
                </svg>
                Anomalies
            </a>
            <a href="settings.html" class="flex items-center gap-3 px-4 py-2 rounded-lg hover:bg-gray-700 transition-colors" style="color: var(--text-secondary); hover:background-color: var(--border-color);">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.942 3.313.823 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.942 1.543-.823 3.313-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.942-3.313-.823-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.942-1.543.823-3.313 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                </svg>
                Parametrlər
            </a>
        </nav>

        <div class="mt-12 text-xs space-y-1" style="color: var(--text-secondary);">
            <p class="font-medium">SIEM Core v2.1.0</p>
            <p>© 2025 SIEM. Bütün hüquqlar qorunur.</p>
        </div>
    </aside>

    <div class="flex-1 p-8 overflow-auto">
        <header class="flex items-center justify-between pb-6 border-b mb-8" style="border-color: var(--border-color);">
            <div>
                <h1 class="text-3xl font-extrabold" style="color: var(--text-primary);">Agent Dashboard</h1>
                <p class="text-sm mt-1" style="color: var(--text-secondary);">Sistemlərinizin real-vaxt SIEM görünüşü və nəzarəti</p>
            </div>

            <div class="flex items-center gap-4">
                <button id="themeToggle" class="w-12 h-6 flex items-center rounded-full p-0.5 shadow-inner transition-colors duration-300">
                    <div id="toggleIndicator" class="h-5 w-5 rounded-full shadow-md transform transition-transform duration-300 flex items-center justify-center text-xs">
                         <svg xmlns="http://www.w3.org/2000/svg" id="modeIcon" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                        </svg>
                    </div>
                </button>
                
                <div class="text-sm mr-4 hidden sm:block" style="color: var(--text-secondary);">Son yenilənmə: <span id="lastUpdated">—</span></div>
                <button id="refreshButton" class="px-4 py-2 rounded-lg text-white font-medium transition-colors shadow-md" style="background-color: var(--indigo-accent); hover:background-color: #3730A3;">Yenilə</button>
                <button id="exportCsv" class="px-4 py-2 border rounded-lg transition-colors" style="border-color: var(--border-color); color: var(--text-secondary); hover:color: var(--text-primary); hover:border-color: var(--text-secondary);">CSV ixrac</button>
            </div>
        </header>

        <section id="stats" class="grid grid-cols-1 md:grid-cols-3 xl:grid-cols-4 gap-6 mb-8">
            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-sm font-semibold" style="color: var(--text-secondary);">Ümumi Agent Sayı</h3>
                <div class="flex items-end justify-between mt-3">
                    <div>
                        <p id="totalAgentsCount" class="text-4xl font-bold" style="color: var(--text-primary);">0</p>
                        <p class="text-xs mt-1" style="color: var(--text-secondary);">Online / Offline</p>
                    </div>
                    <div class="text-right">
                        <p class="text-sm" style="color: var(--text-secondary);">Critical Alerts</p>
                        <p id="criticalAlerts" class="text-2xl font-bold text-red-500">0</p>
                    </div>
                </div>
            </div>

            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-sm font-semibold" style="color: var(--text-secondary);">Son 24 Saatda Əlavə Olunanlar</h3>
                <p id="newAgentsCount" class="text-4xl font-bold text-emerald-400 mt-3">0</p>
                <p class="text-xs mt-1" style="color: var(--text-secondary);">Yeni agentlər və qeydiyyatlar</p>
            </div>

            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-sm font-semibold" style="color: var(--text-secondary);">Orta Ram İstifadəsi</h3>
                <p id="avgRam" class="text-4xl font-bold text-blue-400 mt-3">—%</p>
                <p class="text-xs mt-1" style="color: var(--text-secondary);">Agentlər üzrə orta göstərici</p>
            </div>

            <div class="rounded-xl p-5 card shadow-xl hidden xl:block">
                <h3 class="text-sm font-semibold" style="color: var(--text-secondary);">Yüksək Riskli ƏS</h3>
                <p id="highRiskOS" class="text-2xl font-bold text-yellow-400 mt-3">Windows (24%)</p>
                <p class="text-xs mt-1" style="color: var(--text-secondary);">OS təhlükəsizlik göstəricisi</p>
            </div>
        </section>

        <section class="card rounded-xl p-5 mb-8 flex flex-col md:flex-row items-center justify-between gap-4">
            <h2 class="text-xl font-semibold hidden md:block" style="color: var(--text-primary);">Agentlərə Baxış</h2>

            <div class="flex flex-wrap items-center gap-3 w-full md:w-auto">
                <div class="relative">
                    <select id="osFilter" class="block py-2 px-3 pr-8 rounded-md text-sm focus:outline-none focus:border-indigo-500" 
                            style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        <option value="all">Bütün ƏS</option>
                        <option value="Windows">Windows</option>
                        <option value="Linux">Linux</option>
                        <option value="MacOS">MacOS</option>
                    </select>
                </div>

                <div class="relative">
                    <select id="statusFilter" class="block py-2 px-3 pr-8 rounded-md text-sm focus:outline-none focus:border-indigo-500"
                            style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);">
                        <option value="all">Bütün Statuslar</option>
                        <option value="active">Active</option>
                        <option value="inactive">Inactive</option>
                        <option value="pending">Pending</option>
                    </select>
                </div>

                <input id="searchInput" type="text" placeholder="Ad, IP və ya Hostname axtarın..." class="px-4 py-2 rounded-md text-sm focus:outline-none focus:border-indigo-500 w-full md:w-64" 
                       style="background-color: var(--bg-secondary); border: 1px solid var(--border-color); color: var(--text-primary);" />
            </div>
        </section>

        <div id="loadingMessage" class="flex items-center justify-center h-36 card rounded-xl mb-8">
            <svg class="animate-spin -ml-1 mr-3 h-8 w-8 text-indigo-400" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span class="font-medium" style="color: var(--text-secondary);">Məlumatlar yüklənir...</span>
        </div>

        <div id="tableContainer" class="overflow-x-auto hidden mb-8 card rounded-xl">
            <table id="agents" class="min-w-full">
                <thead class="sticky top-0" style="background-color: var(--bg-secondary); color: var(--text-secondary); border-bottom: 1px solid var(--border-color);">
                    <tr>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Ad</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">ƏS</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">IP Ünvanı</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Status</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Son Görülmə</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">RAM İstifadəsi</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">CPU Nüvələri</th>
                        <th class="py-3 px-4 text-left text-xs font-semibold uppercase tracking-wider">Əməliyyatlar</th>
                    </tr>
                </thead>
                <tbody id="agentTableBody" class="divide-y" style="border-color: var(--border-color);">
                    </tbody>
            </table>
        </div>

        <div id="errorMessage" class="hidden bg-red-900 text-red-200 p-4 rounded-xl mb-8 border border-red-700">
            <p class="font-medium">⚠️ Xəta: Məlumatların yüklənməsində problem yarandı. Lütfən, server bağlantısını yoxlayın.</p>
        </div>

        <section id="incidents" class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--indigo-accent);">Son İnsidentlər</h3>
                <ul id="recentIncidents" class="text-sm space-y-3" style="color: var(--text-primary);">
                    <li class="flex items-start gap-2"><span class="text-red-400 font-bold">●</span> İnfo: Agentlərdən 3 kritik xəbərdarlıq.</li>
                    <li class="flex items-start gap-2"><span class="text-yellow-400 font-bold">●</span> Warning: 7 şübhəli giriş cəhdləri.</li>
                    <li class="flex items-start gap-2" style="color: var(--text-secondary);"><span class="text-gray-500 font-bold">●</span> Log: 2 yeni agent qeydiyyatı.</li>
                </ul>
                <a href="anomalies.html" class="mt-4 inline-block hover:text-indigo-300 text-sm font-medium transition-colors" style="color: var(--indigo-accent);">Bütün İnsidentlər &rarr;</a>
            </div>

            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--indigo-accent);">Sistem Xülasəsi</h3>
                <p class="text-sm" style="color: var(--text-primary);">Sistem monitorinqi normaldır. Yüksək RAM istifadəsi olan agentlər üçün xüsusi yoxlamalar tövsiyə olunur.</p>
                <button class="mt-4 w-full px-3 py-2 border rounded-lg transition-colors text-sm" 
                        style="border-color: var(--indigo-accent); color: var(--indigo-accent); hover:background-color: var(--indigo-accent); hover:color: white;">Monitorinq Hesabatı</button>
            </div>

            <div class="rounded-xl p-5 card shadow-xl">
                <h3 class="text-lg font-semibold mb-3" style="color: var(--indigo-accent);">Əməliyyatlar</h3>
                <div class="mt-3 space-y-3">
                    <button class="w-full px-4 py-3 rounded-lg text-white font-semibold transition-colors shadow-lg" 
                            style="background-color: var(--indigo-accent); hover:background-color: #3730A3;">Yeni İnsident Yarat</button>
                    <button class="w-full px-4 py-3 border rounded-lg transition-colors" 
                            style="border-color: var(--border-color); color: var(--text-primary); hover:border-color: var(--indigo-accent); hover:color: var(--indigo-accent);">Axtarış Filtrini Saxla</button>
                </div>
            </div>
        </section>

        <div id="infoModal" class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center p-4 hidden z-50 transition-opacity duration-300">
            <div class="card rounded-xl shadow-2xl w-full max-w-2xl p-6 relative transform transition-transform duration-300 scale-95 opacity-0" id="modalDialog" 
                 style="background-color: var(--bg-secondary); color: var(--text-primary);">
                <button id="closeModal" class="absolute top-4 right-4 hover:text-white transition-colors" style="color: var(--text-secondary);">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                </button>
                <h2 id="modalAgentName" class="text-2xl font-bold mb-4 pb-2" style="border-color: var(--border-color); color: var(--indigo-accent);">Agent</h2>
                <div id="modalContent" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm" style="color: var(--text-primary);">
                    <p><strong>Agent ID:</strong> <span id="modalAgentId" style="color: var(--text-primary);"></span></p>
                    <p><strong>ƏS:</strong> <span id="modalAgentOS" style="color: var(--text-primary);"></span></p>
                    <p><strong>IP Ünvanı:</strong> <span id="modalAgentIP" style="color: var(--text-primary);"></span></p>
                    <p><strong>Host Adı:</strong> <span id="modalAgentHostname" style="color: var(--text-primary);"></span></p>
                    <p><strong>CPU Nüvələri:</strong> <span id="modalAgentCPUCores" style="color: var(--text-primary);"></span></p>
                    <p><strong>Ümumi Yaddaş:</strong> <span id="modalAgentTotalMemory" style="color: var(--text-primary);"></span></p>
                    <p><strong>Agent Versiyası:</strong> <span id="modalAgentVersion" style="color: var(--text-primary);"></span></p>
                    <p><strong>Son Görülmə:</strong> <span id="modalAgentLastSeen" style="color: var(--text-primary);"></span></p>
                </div>
                <div class="mt-6 flex justify-end gap-3 pt-4" style="border-top: 1px solid var(--border-color);">
                    <button id="modalCloseBtn" class="px-4 py-2 border rounded-lg transition-colors" 
                            style="border-color: var(--border-color); color: var(--text-primary); hover:border-color: var(--text-secondary);">Bağla</button>
                    <a id="agentDetailsLink" href="#" class="px-4 py-2 rounded-lg text-white font-medium transition-colors" 
                       style="background-color: var(--indigo-accent); hover:background-color: #3730A3;">Tam Detallar &rarr;</a>
                </div>
            </div>
        </div>

        <footer class="text-xs mt-12 flex justify-between items-center pt-4" style="color: var(--text-secondary); border-top: 1px solid var(--border-color);">
            <p class="text-sm">Korporativ Təhlükəsizlik Sistemi | Bütün hüquqlar qorunur. © 2025 SIEM</p>
            <img src="mn.png" alt="MN Korporativ Şəkil" class="h-12 object-contain opacity-80" />
        </footer>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const htmlElement = document.documentElement;
            const themeToggle = document.getElementById('themeToggle');
            const toggleIndicator = document.getElementById('toggleIndicator');
            const modeIcon = document.getElementById('modeIcon');
            
            // --- Theme Functions ---
            
            function updateTheme(isLight) {
                if (isLight) {
                    htmlElement.classList.add('light-mode');
                    htmlElement.classList.remove('dark-mode');
                    // Move indicator to the right (100% of w-12 container)
                    toggleIndicator.style.transform = 'translateX(100%)';
                    modeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />`; // Sun icon
                } else {
                    htmlElement.classList.remove('light-mode');
                    htmlElement.classList.add('dark-mode');
                    // Move indicator to the left (0)
                    toggleIndicator.style.transform = 'translateX(0)';
                    modeIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />`; // Moon icon
                }
            }

            // 1. Check saved preference or default to dark
            const savedTheme = localStorage.getItem('theme');
            const isLightMode = savedTheme === 'light';
            updateTheme(isLightMode);

            // 2. Toggle button listener
            themeToggle.addEventListener('click', () => {
                const isCurrentlyLight = htmlElement.classList.contains('light-mode');
                const newTheme = isCurrentlyLight ? 'dark' : 'light';
                localStorage.setItem('theme', newTheme);
                updateTheme(!isCurrentlyLight);
            });
            
            // --- Existing Dashboard Logic ---
            
            const loadingMessage = document.getElementById('loadingMessage');
            const tableContainer = document.getElementById('tableContainer');
            const errorMessage = document.getElementById('errorMessage');
            const tbody = document.getElementById('agentTableBody');
            const totalAgentsCountElem = document.getElementById('totalAgentsCount');
            const newAgentsCountElem = document.getElementById('newAgentsCount');
            const refreshButton = document.getElementById('refreshButton');
            const osFilter = document.getElementById('osFilter');
            const statusFilter = document.getElementById('statusFilter');
            const searchInput = document.getElementById('searchInput');
            const lastUpdated = document.getElementById('lastUpdated');
            const exportCsv = document.getElementById('exportCsv');

            const infoModal = document.getElementById('infoModal');
            const modalDialog = document.getElementById('modalDialog');
            const closeModalBtn = document.getElementById('closeModal');
            const modalAgentName = document.getElementById('modalAgentName');
            const modalAgentId = document.getElementById('modalAgentId');
            const modalAgentOS = document.getElementById('modalAgentOS');
            const modalAgentIP = document.getElementById('modalAgentIP');
            const modalAgentHostname = document.getElementById('modalAgentHostname');
            const modalAgentCPUCores = document.getElementById('modalAgentCPUCores');
            const modalAgentTotalMemory = document.getElementById('modalAgentTotalMemory');
            const modalAgentVersion = document.getElementById('modalAgentVersion');
            const modalAgentLastSeen = document.getElementById('modalAgentLastSeen');
            const agentDetailsLink = document.getElementById('agentDetailsLink');
            const modalCloseBtn = document.getElementById('modalCloseBtn');

            let allAgents = []; 

            async function fetchAgents() {
                loadingMessage.classList.remove('hidden');
                tableContainer.classList.add('hidden');
                errorMessage.classList.add('hidden');

                try {
                    const response = await fetch('http://localhost:5000/api/agents');

                    if (!response.ok) {
                        throw new Error(`HTTP error! Status: ${response.status}`);
                    }

                    allAgents = await response.json();
                    updateStats(allAgents);
                    filterAndRenderAgents();

                    loadingMessage.classList.add('hidden');
                    tableContainer.classList.remove('hidden');
                    lastUpdated.textContent = new Date().toLocaleString('az-AZ');

                } catch (err) {
                    console.error('Agentlərin yüklənməsində xəta:', err);
                    loadingMessage.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            }

            function updateStats(agents) {
                const onlineCount = agents.filter(a => a.status === 'active').length;
                const offlineCount = agents.filter(a => a.status === 'inactive').length;
                totalAgentsCountElem.innerHTML = `${agents.length} <span class="text-sm text-emerald-400 ml-2">(${onlineCount} / ${offlineCount})</span>`;
                
                const twentyFourHoursAgo = new Date();
                twentyFourHoursAgo.setHours(twentyFourHoursAgo.getHours() - 24);
                const newAgents = agents.filter(agent => new Date(agent.registeredAt) >= twentyFourHoursAgo);
                newAgentsCountElem.textContent = newAgents.length;

                let ramSum = 0;
                let ramCount = 0;
                let critical = 0;
                agents.forEach(agent => {
                    const latest = agent.agentDataHistory?.[0] ?? {};
                    const ramPercent = latest.ramData?.percent;
                    if (typeof ramPercent === 'number') { ramSum += ramPercent; ramCount++; }
                    if (agent.alerts?.some(a => a.severity === 'critical')) critical++;
                });
                document.getElementById('avgRam').textContent = ramCount ? (ramSum / ramCount).toFixed(1) + '%' : '—%';
                document.getElementById('criticalAlerts').textContent = critical;
            }

            function renderAgents(agentsToRender) {
                tbody.innerHTML = '';

                if (agentsToRender.length === 0) {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td colspan="8" class="py-6 text-center" style="color: var(--text-secondary);">Axtarış kriteriyalarına uyğun heç bir agent tapılmadı.</td>`;
                    tbody.appendChild(row);
                    return;
                }

                agentsToRender.forEach(agent => {
                    const latestData = agent.agentDataHistory?.[0] || {};
                    const ramPercent = latestData.ramData?.percent ?? 'N/A';
                    const cpuCores = agent.systemInfo?.cpuCores ?? 'N/A';
                    const lastSeenDate = new Date(agent.lastSeen);
                    const formattedLastSeen = isNaN(lastSeenDate) ? 'N/A' : lastSeenDate.toLocaleString('az-AZ', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });

                    const row = document.createElement('tr');
                    row.style.setProperty('color', 'var(--text-primary)'); 
                    row.onmouseover = () => row.style.backgroundColor = htmlElement.classList.contains('light-mode') ? '#f0f4f8' : '#1f2937';
                    row.onmouseout = () => row.style.backgroundColor = 'transparent';

                    row.innerHTML = `
                        <td class="py-3 px-4 text-sm font-medium whitespace-nowrap">${agent.name}</td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap" style="color: var(--text-secondary);">${agent.os}</td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap" style="color: var(--text-secondary);">${agent.ipAddress}</td>
                        <td class="py-3 px-4 text-sm font-medium whitespace-nowrap">
                            <span class="status-${agent.status}">${agent.status.charAt(0).toUpperCase() + agent.status.slice(1)}</span>
                        </td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap" style="color: var(--text-secondary);">${formattedLastSeen}</td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap font-medium text-blue-300">${ramPercent !== 'N/A' ? Number(ramPercent).toFixed(1) + '%' : 'N/A'}</td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap" style="color: var(--text-secondary);">${cpuCores}</td>
                        <td class="py-3 px-4 text-sm whitespace-nowrap space-x-2">
                            <button class="info-btn px-3 py-1 text-xs font-semibold rounded-md transition-colors" 
                                style="background-color: var(--border-color); color: var(--text-primary);" data-agent-id="${agent._id}">Info</button>
                            <a href="agent-detail.html?id=${agent._id}" class="px-3 py-1 text-xs font-semibold rounded-md text-white transition-colors" 
                                style="background-color: var(--indigo-accent);">Detallar</a>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            }

            function filterAndRenderAgents() {
                const os = osFilter.value;
                const status = statusFilter.value;
                const searchTerm = searchInput.value.toLowerCase().trim();

                let filteredAgents = allAgents.filter(agent => {
                    if (os !== 'all' && agent.os !== os) return false;
                    if (status !== 'all' && agent.status !== status) return false;
                    if (searchTerm !== '' && !agent.name.toLowerCase().includes(searchTerm) && !agent.ipAddress.includes(searchTerm) && !agent.systemInfo?.hostname?.toLowerCase().includes(searchTerm)) return false;
                    return true;
                });

                renderAgents(filteredAgents);
            }

            // Modal logic functions (unchanged)
            function openInfoModal(agentId) { /* ... implementation ... */ }
            function closeInfoModal() { /* ... implementation ... */ }
            function exportTableToCSV(filename = 'agents.csv') { /* ... implementation ... */ }

            fetchAgents();
            setInterval(fetchAgents, 30000);

            refreshButton.addEventListener('click', fetchAgents);
            osFilter.addEventListener('change', filterAndRenderAgents);
            statusFilter.addEventListener('change', filterAndRenderAgents);
            searchInput.addEventListener('input', filterAndRenderAgents);
            exportCsv.addEventListener('click', () => exportTableToCSV());

            tbody.addEventListener('click', (event) => {
                const infoBtn = event.target.closest('.info-btn');
                if (infoBtn) { 
                    const agent = allAgents.find(a => a._id === infoBtn.getAttribute('data-agent-id'));
                    if (agent) {
                         modalAgentName.textContent = agent.name;
                         modalAgentId.textContent = agent._id;
                         modalAgentOS.textContent = agent.os;
                         modalAgentIP.textContent = agent.ipAddress;
                         modalAgentHostname.textContent = agent.systemInfo?.hostname ?? 'N/A';
                         modalAgentCPUCores.textContent = agent.systemInfo?.cpuCores ?? 'N/A';
                         modalAgentTotalMemory.textContent = agent.systemInfo?.totalMemory ? (agent.systemInfo.totalMemory / (1024 * 1024 * 1024)).toFixed(2) + ' GB' : 'N/A';
                         modalAgentVersion.textContent = agent.version ?? 'N/A';
                         modalAgentLastSeen.textContent = new Date(agent.lastSeen).toLocaleString('az-AZ');
                         agentDetailsLink.href = `agent-detail.html?id=${agent._id}`;
                        
                         infoModal.classList.remove('hidden');
                         setTimeout(() => {
                             infoModal.classList.add('opacity-100');
                             modalDialog.classList.remove('scale-95', 'opacity-0');
                             modalDialog.classList.add('scale-100', 'opacity-100');
                         }, 10); 
                    }
                }
            });

            closeModalBtn.addEventListener('click', () => {
                 modalDialog.classList.remove('scale-100', 'opacity-100');
                 modalDialog.classList.add('scale-95', 'opacity-0');
                 infoModal.classList.remove('opacity-100');
                 setTimeout(() => { infoModal.classList.add('hidden'); }, 300);
            });
            modalCloseBtn.addEventListener('click', () => {
                 modalDialog.classList.remove('scale-100', 'opacity-100');
                 modalDialog.classList.add('scale-95', 'opacity-0');
                 infoModal.classList.remove('opacity-100');
                 setTimeout(() => { infoModal.classList.add('hidden'); }, 300);
            });
            infoModal.addEventListener('click', (event) => { 
                if (event.target === infoModal) { 
                     modalDialog.classList.remove('scale-100', 'opacity-100');
                     modalDialog.classList.add('scale-95', 'opacity-0');
                     infoModal.classList.remove('opacity-100');
                     setTimeout(() => { infoModal.classList.add('hidden'); }, 300);
                } 
            });
            document.addEventListener('keydown', (e) => { 
                if (e.key === 'Escape' && !infoModal.classList.contains('hidden')) { 
                    modalDialog.classList.remove('scale-100', 'opacity-100');
                    modalDialog.classList.add('scale-95', 'opacity-0');
                    infoModal.classList.remove('opacity-100');
                    setTimeout(() => { infoModal.classList.add('hidden'); }, 300);
                } 
            });
            
            document.getElementById('highRiskOS').textContent = 'Windows (74 Agent)';
            
            const recentIncidentsElem = document.getElementById('recentIncidents');
            recentIncidentsElem.innerHTML = `
                <li class="flex items-start gap-2"><span class="text-red-400 font-bold">●</span> İnfo: Agentlərdən 3 kritik xəbərdarlıq.</li>
                <li class="flex items-start gap-2"><span class="text-yellow-400 font-bold">●</span> Warning: 7 şübhəli giriş cəhdləri.</li>
                <li class="flex items-start gap-2" style="color: var(--text-secondary);"><span class="text-gray-500 font-bold">●</span> Log: 2 yeni agent qeydiyyatı.</li>
            `;
        });
    </script>
</body>

</html>
